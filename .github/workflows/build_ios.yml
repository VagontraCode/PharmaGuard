name: Build iOS

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_ios:
    name: Build iOS App
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Enable iOS platform (generates Podfile)
        run: |
          # This creates the ios folder structure and Podfile if not present
          flutter config --enable-ios
          flutter create . --platforms=ios

      - name: Fix iOS 14.0 Deployment Target
        run: |
          echo "Fixing iOS deployment target for workmanager_apple compatibility..."
          
          # Update Podfile to iOS 14.0
          if [ -f "ios/Podfile" ]; then
            cp ios/Podfile ios/Podfile.backup
            
            if grep -q "platform :ios" ios/Podfile; then
              sed -i '' "s/platform :ios, '[0-9]*\.[0-9]*'/platform :ios, '14.0'/g" ios/Podfile
            else
              sed -i '' "1i\\
          platform :ios, '14.0'
          " ios/Podfile
            fi
            echo "✅ Podfile updated"
          fi
          
          # Update Xcode project
          if [ -f "ios/Runner.xcodeproj/project.pbxproj" ]; then
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9]*\.[0-9]*;/IPHONEOS_DEPLOYMENT_TARGET = 14.0;/g' ios/Runner.xcodeproj/project.pbxproj
            echo "✅ Xcode project updated"
          fi

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Install iOS Pods
        working-directory: ios
        run: pod install --repo-update

      - name: Build iOS (No Codesign)
        run: flutter build ios --release --no-codesign